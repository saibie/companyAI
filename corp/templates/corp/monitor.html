{% extends 'corp/base.html' %}

{% block title %}System Monitor - AI Corp{% endblock %}

{% block content %}
<div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <h2>ðŸ”§ System Monitor</h2>
        <a href="{% url 'corp:dashboard' %}" class="btn btn-primary">Go to Dashboard</a>
    </div>
    
    <p style="color:#666; margin-bottom:20px;">
        View and manage ALL tasks within your organization, including internal agent-to-agent delegations.
    </p>

    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; background: white;">
            <thead>
                <tr style="background: #f8f9fa; text-align: left; border-bottom: 2px solid #dee2e6;">
                    <th style="padding: 12px;">Status</th>
                    <th style="padding: 12px;">Task</th>
                    <th style="padding: 12px;">From &rarr; To</th>
                    <th style="padding: 12px;">Actions (Force)</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 12px;">
                        <span class="status-badge {{ task.status }}" 
                              style="padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: bold;
                              {% if task.status == 'WAIT_APPROVAL' %}background:#e2e6ea; color:#333;
                              {% elif task.status == 'THINKING' %}background:#cce5ff; color:#004085;
                              {% elif task.status == 'WAIT_ANSWER' %}background:#fff3cd; color:#856404;
                              {% elif task.status == 'DONE' %}background:#d4edda; color:#155724;
                              {% else %}background:#f8f9fa; color:#666;{% endif %}">
                            {{ task.get_status_display }}
                        </span>
                    </td>
                    <td style="padding: 12px;">
                        <div style="font-weight: bold; margin-bottom: 4px;">{{ task.title }}</div>
                        <div style="font-size: 0.85em; color: #666;">{{ task.description|truncatechars:50 }}</div>
                        <div style="font-size: 0.8em; color: #999;">{{ task.created_at|date:"m/d H:i" }}</div>
                    </td>
                    <td style="padding: 12px; font-size: 0.9em;">
                        {% if task.creator %}
                            ðŸ¤– {{ task.creator.name }}
                        {% else %}
                            ðŸ‘¤ <strong>User</strong>
                        {% endif %}
                        <br>&darr;<br>
                        ðŸ¤– {{ task.assignee.name }}
                    </td>
                    <td style="padding: 12px;">
                        <div style="display: flex; gap: 5px;">
                            {% if task.status != 'DONE' %}
                                <form method="post" style="margin:0;">
                                    {% csrf_token %}
                                    <input type="hidden" name="task_id" value="{{ task.id }}">
                                    <input type="hidden" name="action" value="force_reject">
                                    <button type="submit" class="btn btn-danger btn-sm" title="Force Retry/Reset">ðŸ”„ Retry</button>
                                </form>
                                <form method="post" style="margin:0;">
                                    {% csrf_token %}
                                    <input type="hidden" name="task_id" value="{{ task.id }}">
                                    <input type="hidden" name="action" value="force_done">
                                    <button type="submit" class="btn btn-success btn-sm" title="Force Complete">âœ… Done</button>
                                </form>
                            {% else %}
                                <span style="color:#ccc;">-</span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" style="text-align:center; padding: 20px;">No tasks found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}